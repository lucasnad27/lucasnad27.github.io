"use strict";function makeGraph(){n=2,m=5;var a=d3.layout.stack(),b=a(d3.range(n).map(function(a){return getVariableValues(a)}));yGroupMax=d3.max(b,function(a){return d3.max(a,function(a){return a.y})}),yStackMax=d3.max(b,function(a){return d3.max(a,function(a){return a.y0+a.y})}),margin={top:20,right:30,bottom:30,left:40},width=600-margin.left-margin.right,height=500-margin.top-margin.bottom,x=d3.scale.ordinal().domain(data.map(function(a){return a.city})).rangeRoundBands([0,width],.1),y=d3.scale.linear().domain([0,yStackMax]).range([height,0]);var c=d3.scale.linear().domain([0,n-1]).range([{color:"#7C858B",text:"Customer"},{color:"#D75662",text:"Subscriber"}]),d=d3.svg.axis().scale(x).tickSize(0).tickPadding(6).orient("bottom"),e=d3.svg.axis().scale(y).orient("left").ticks(10),f=d3.select(".chart").attr("width",width+margin.left+margin.right).attr("height",height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")");f.append("g").attr("class","x axis").attr("transform","translate(0,"+height+")").call(d),f.append("g").attr("class","y axis").call(e).append("text").attr("transform","rotate(-90)").attr("y",-40).attr("x",0-.67*height).attr("dy",".71em").style("text-anchor","end").attr("style","font-size:14px;").text("Median Trip Duration (minutes)"),console.log(height);var g=f.selectAll(".layer").data(b).enter().append("g").attr("class","layer").style("fill",function(a,b){return c(b).color}),h=f.selectAll(".legend").data(c.range().map(function(a){return a.text}).reverse()).enter().append("g").attr("class","legend").attr("transform",function(a,b){return"translate(0,"+20*b+")"}),i=120;h.append("rect").attr("x",i+6).attr("width",18).attr("height",18).style("fill",function(a,b){return c(b).color}),h.append("text").attr("x",i).attr("y",9).attr("dy",".35em").style("text-anchor","end").text(function(a){return a}),rect=g.selectAll("rect").data(function(a){return a}).enter().append("rect").attr("class","bar").attr("x",function(a){return x(a.x)}).attr("y",height).attr("width",x.rangeBand()).attr("height",0),rect.transition().delay(function(a,b){return 10*b}).attr("y",function(a){return y(a.y0+a.y)}).attr("height",function(a){return y(a.y0)-y(a.y0+a.y)}),d3.selectAll("input").on("change",change)}function change(){asyncCallsRemaining>0||(clearTimeout(timeout),"grouped"===this.value?transitionGrouped():transitionStacked())}function transitionGrouped(){y.domain([0,yGroupMax]),rect.transition().duration(500).delay(function(a,b){return 10*b}).attr("x",function(a,b,c){return x(a.x)+x.rangeBand()/n*c}).attr("width",x.rangeBand()/n).transition().attr("y",function(a){return y(a.y)}).attr("height",function(a){return height-y(a.y)})}function transitionStacked(){y.domain([0,yStackMax]),rect.transition().duration(500).delay(function(a,b){return 10*b}).attr("y",function(a){return y(a.y0+a.y)}).attr("height",function(a){return y(a.y0)-y(a.y0+a.y)}).transition().attr("x",function(a){return x(a.x)}).attr("width",x.rangeBand())}function getVariableValues(a){return data.map(0===a?function(a){return{x:a.city,y:a.subscriberDuration,totalMinutes:a.avgMinutes}}:function(a){return{x:a.city,y:a.customerDuration,totalMinutes:a.avgMinutes}})}function asyncCallComplete(){--asyncCallsRemaining,0>=asyncCallsRemaining&&makeGraph()}var stations={},data,asyncCallsRemaining=2,n,m,stack,layers,yGroupMax,yStackMax,x,y,margin,width,height,rect,timeout=setTimeout(function(){d3.select('input[value="grouped"]').property("checked",!0).each(change)},2e3);d3.csv("data/201402_station_data.csv",function(a){return a},function(a,b){b.forEach(function(a){stations[a.name]=a.landmark}),asyncCallComplete()}),d3.csv("data/201402_trip_data.csv",function(a,b){b.forEach(function(a){a.city=stations[a["Start Station"]]}),data=d3.nest().key(function(a){return a.city}).key(function(a){return a["Subscription Type"]}).sortKeys(d3.ascending).rollup(function(a){return d3.median(a,function(a){return a.Duration/60})}).entries(b),data.forEach(function(a){a.city=a.key,a.subscriberDuration=Math.round(100*a.values[1].values)/100,a.customerDuration=Math.round(100*a.values[0].values)/100,a.avgMinutes=a.subscriberDuration+a.customerDuration}),asyncCallComplete()});